<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Concentra — New Hire Dashboard</title>

  <!-- Fast, inline-first page -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#101828; --muted:#667085; --accent:#ff6a21;
      --ink-2:#0f172a; --line:#e7eaf3; --radius:18px;
      --shadow:0 12px 36px rgba(16,24,40,.10); --focus:0 0 0 3px rgba(255,106,33,.28);
      --success:#16a34a; --error:#dc2626;
    }
    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      padding:28px;
    }
    .shell{
      max-width:1200px; margin:0 auto;
      background:linear-gradient(180deg,#ffffff,#fbfcff);
      border:1px solid var(--line);
      border-radius:calc(var(--radius) + 6px);
      box-shadow:var(--shadow); overflow:hidden; position:relative;
    }

    /* Top */
    header.top{
      display:flex; justify-content:space-between; align-items:center;
      padding:18px 22px; border-bottom:1px solid var(--line); background:#fff;
    }
    .title{display:flex; align-items:center; gap:10px; font-weight:800; color:var(--ink-2)}
    .nav{display:flex; gap:10px}
    .nav a{font-weight:800; color:#111; text-decoration:none; border:1px solid var(--line); padding:8px 12px; border-radius:999px; background:#fff}

    main{padding:24px; display:grid; grid-template-columns:1.05fr 1fr; gap:20px}
    @media (max-width:980px){ main{ grid-template-columns:1fr } }

    /* Info column */
    .info{display:flex; flex-direction:column; gap:14px}
    .headline{font-size:clamp(20px,3vw,28px); margin:6px 0 4px}
    .sub{color:var(--muted); max-width:60ch}
    .callout{background:#fff; border:1px solid var(--line); border-radius:14px; padding:16px}

    /* Right panel */
    .panel{background:#fff; border:1px solid var(--line); border-radius:var(--radius); box-shadow:0 12px 28px rgba(16,24,40,.08); overflow:hidden}
    .panel header{background:#fff; border-bottom:1px solid var(--line); padding:14px 18px; font-weight:800}
    .panel .body{padding:18px}

    /* Lookup row */
    .finder{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .finder input[type="text"]{
      flex:1 1 220px; min-width:220px;
      border:1px solid var(--line); border-radius:14px; padding:12px 12px; font-size:16px; outline:none;
      background:#fff; color:#101828;
    }
    .finder input:focus{border-color:#ff8a4a; box-shadow:var(--focus)}
    .btn{appearance:none; border:none; border-radius:999px; background:var(--accent); color:#fff; padding:12px 18px; font-weight:900; cursor:pointer}
    .btn.secondary{background:#fff; color:#111; border:1px solid var(--line)}
    .btn.ghost{background:transparent; color:var(--accent); border:1px dashed var(--accent)}
    .muted{color:var(--muted); font-size:13px}

    /* Summary grid */
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:12px 0}
    @media (max-width:680px){ .row{ grid-template-columns:1fr } }
    .chips{display:flex; gap:10px; flex-wrap:wrap; margin-top:6px}
    .chip{
      border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:13px;
      background:#fff; color:#344054;
    }

    /* Steps */
    .steps{display:grid; gap:10px; margin-top:10px}
    .step{display:flex; align-items:center; gap:10px; padding:8px 10px; border:1px solid var(--line); border-radius:12px; background:#fff}
    .dot{width:22px; height:22px; border-radius:50%; border:2px solid #d1d5db; display:grid; place-items:center; font-size:12px; color:#6b7280; flex:0 0 22px}
    .done .dot{background:var(--success); border-color:var(--success); color:#fff}
    .label{color:#475467}
    .timeago{font-size:12px; color:#667085}

    /* Status / errors */
    .status{min-height:20px; font-size:13px; color:#667085}
    .status.error{color:var(--error)}
    .divider{height:1px; background:var(--line); margin:12px 0}
  </style>
</head>
<body>
  <div class="shell">
    <header class="top">
      <div class="title">New Hire Dashboard</div>
      <nav class="nav">
        <a href="/index.html">New Hire Form</a>
        <a href="/admin-login.html">Admin Login</a>
      </nav>
    </header>

    <main>
      <!-- Left info -->
      <section class="info">
        <h2 class="headline">Track your request in real time.</h2>
        <p class="sub">
          Paste your <strong>Submission ID</strong> (or open this page from the form’s success dialog).
          You’ll see step‑by‑step status and a clear summary.
        </p>
        <div class="callout">
          <strong>Tip</strong>
          <div class="muted">Bookmark this page with your Submission ID in the URL for one‑click access later.</div>
        </div>
      </section>

      <!-- Right: Lookup + Results -->
      <section class="panel">
        <header>Lookup</header>
        <div class="body">
          <div class="finder" style="margin-bottom:12px">
            <input id="subIdInput" placeholder="Submission ID" inputmode="numeric" />
            <button class="btn" id="loadBtn">Load</button>
            <button class="btn secondary" id="refreshBtn" title="Refresh">Refresh</button>
            <label style="display:flex;align-items:center;gap:8px;margin-left:auto">
              <input id="autoRefresh" type="checkbox" />
              <span class="muted">Auto‑refresh (10s)</span>
            </label>
          </div>
          <div id="status" class="status"></div>
          <div id="content"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function () {
      const statusEl = document.getElementById('status');
      const content = document.getElementById('content');
      const idInput = document.getElementById('subIdInput');
      const loadBtn = document.getElementById('loadBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const autoRefresh = document.getElementById('autoRefresh');
      let timer = null;

      function q(k){ return new URLSearchParams(location.search).get(k) }
      function esc(s){ return String(s||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])) }
      const plural = (n, w) => `${n} ${w}${n===1?'':'s'}`;
      function timeAgo(iso){
        if(!iso) return '';
        const then = new Date(iso).getTime();
        if (Number.isNaN(then)) return '';
        const now = Date.now();
        const secs = Math.max(0, Math.floor((now-then)/1000));
        if (secs < 60) return plural(secs,'sec') + ' ago';
        const mins = Math.floor(secs/60); if (mins < 60) return plural(mins,'min') + ' ago';
        const hrs = Math.floor(mins/60); if (hrs < 24) return plural(hrs,'hour') + ' ago';
        const days = Math.floor(hrs/24); return plural(days,'day') + ' ago';
      }
      function renderList(list, emptyLabel){
        if (!list || !list.length) return `<span class="muted">${esc(emptyLabel)}</span>`;
        return list.map(x => `<span class="chip">${esc(x)}</span>`).join('');
      }

      async function load(id, opts = {silent:false}){
        if(!id){
          content.innerHTML = '';
          statusEl.className = 'status';
          statusEl.textContent = 'Provide a Submission ID to view status.';
          return;
        }
        if(!opts.silent){
          statusEl.className = 'status';
          statusEl.textContent = 'Loading...';
          content.innerHTML = '';
        }
        try{
          const res = await fetch(`/api/submission/${encodeURIComponent(id)}`, { credentials: 'same-origin' });
          if(!res.ok) {
            // 404 or other error
            const msg = res.status === 404 ? 'Submission not found.' : 'Failed to load submission.';
            throw new Error(msg);
          }

          const data = await res.json();
          const s = data.submission || {};
          const steps = Array.isArray(data.steps) ? data.steps : [];
          const statusRows = Array.isArray(data.status) ? data.status : [];
          const statusMap = new Map(statusRows.map(x => [Number(x.stepIndex), Number(x.isComplete)]));

          // Parse arrays if stored as JSON strings in DB
          const eq = Array.isArray(s.equipment) ? s.equipment
                   : (typeof s.equipment === 'string' && s.equipment.trim().startsWith('[') ? JSON.parse(s.equipment) : []);
          const sw = Array.isArray(s.software) ? s.software
                   : (typeof s.software === 'string' && s.software.trim().startsWith('[') ? JSON.parse(s.software) : []);

          const stepsHtml = steps.map((label, i)=>{
            const idx = i + 1; // stepIndex is 1-based in your DB
            const done = statusMap.get(idx) === 1;
            return `
              <div class="step ${done?'done':''}">
                <div class="dot">${idx}</div>
                <div class="label">${esc(label)}</div>
              </div>
            `;
          }).join('');

          content.innerHTML = `
            <div class="panel" style="margin-top:4px">
              <header>Submission Summary</header>
              <div class="body">
                <div class="row">
                  <div>
                    <div><strong>Name:</strong> ${esc(s.fullName)}</div>
                    <div><strong>Personal Email:</strong> ${esc(s.personalEmail)}</div>
                    <div><strong>Job Title:</strong> ${esc(s.jobTitle)}</div>
                    <div><strong>Department:</strong> ${esc(s.department || '—')}</div>
                    <div><strong>Manager:</strong> ${esc(s.manager || '—')}</div>
                  </div>
                  <div>
                    <div><strong>Start Date:</strong> ${esc(s.startDate)}</div>
                    <div><strong>Office:</strong> ${esc(s.office)}</div>
                    <div style="display:flex;align-items:center;gap:10px;">
                      <div><strong>Submission ID:</strong> <span id="sidVal">${esc(s.id)}</span></div>
                      <button class="btn ghost" id="copyIdBtn" title="Copy ID">Copy</button>
                    </div>
                    <div class="timeago"><strong>Created:</strong> ${esc(s.createdAt || '')} • ${esc(timeAgo(s.createdAt))}</div>
                  </div>
                </div>

                <div class="divider"></div>

                <div class="row">
                  <div>
                    <div><strong>Software</strong></div>
                    <div class="chips" style="margin-top:6px">${renderList(sw, 'No software selected')}</div>
                  </div>
                  <div>
                    <div><strong>Equipment</strong></div>
                    <div class="chips" style="margin-top:6px">${renderList(eq, 'No equipment selected')}</div>
                  </div>
                </div>

                <h3 style="margin:12px 0 6px">Progress</h3>
                <div class="steps">${stepsHtml}</div>
              </div>
            </div>
          `;

          // Copy button
          const copyBtn = document.getElementById('copyIdBtn');
          if (copyBtn) {
            copyBtn.addEventListener('click', async () => {
              try {
                await navigator.clipboard.writeText(String(s.id));
                const old = copyBtn.textContent;
                copyBtn.textContent = 'Copied';
                setTimeout(()=> copyBtn.textContent = old, 1200);
              } catch(_) {}
            });
          }

          statusEl.className = 'status';
          statusEl.textContent = 'Loaded.';
        }catch(e){
          statusEl.className = 'status error';
          statusEl.textContent = e.message || 'Error loading submission.';
          content.innerHTML = '';
        }
      }

      // Prefill from URL and load
      const idFromUrl = q('id');
      if (idFromUrl) {
        idInput.value = idFromUrl;
        load(idFromUrl);
      } else {
        statusEl.textContent = 'Provide a Submission ID to view status.';
      }

      // Events
      loadBtn.addEventListener('click', () => load(idInput.value.trim()));
      refreshBtn.addEventListener('click', () => load(idInput.value.trim(), {silent:false}));
      idInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') load(idInput.value.trim()); });

      // Auto-refresh every 10s when enabled
      autoRefresh.addEventListener('change', () => {
        clearInterval(timer);
        if (autoRefresh.checked) {
          timer = setInterval(() => load(idInput.value.trim(), {silent:true}), 10_000);
        }
      });
    })();
  </script>
</body>
</html>